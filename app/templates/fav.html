<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Favorites - Website Blocker Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Flash message handling
      const flashMessages = JSON.parse('{{ get_flashed_messages(with_categories=True) | tojson | safe }}');
      flashMessages.forEach(([category, message]) => {
        Swal.fire({
          icon: category === 'success' ? 'success' : 'error',
          title: category.charAt(0).toUpperCase() + category.slice(1),
          text: message,
        });
      });
    });

    // Toggle the entire category's favorite status
    function toggleCategoryFavorite(event, categoryId, categoryType) {
      event.stopPropagation();
      fetch(`/add_to_favorites/${categoryId}/${categoryType}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "XMLHttpRequest"
        },
        body: JSON.stringify({})
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          let icon = event.target;
          icon.innerText = (icon.innerText === "❤️") ? "♡" : "❤️";
          icon.classList.toggle("favorited");
          // Optionally, update the UI for all website items in this category.
        } else {
          Swal.fire("Error", data.message, "error");
        }
      })
      .catch(error => console.error("Error:", error));
    }

    // Toggle an individual website's favorite status
    function toggleWebsiteFavorite(event, categoryId, categoryType, websiteUrl) {
      event.stopPropagation();
      fetch(`/toggle_website_favorite/${categoryId}/${categoryType}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "XMLHttpRequest"
        },
        body: JSON.stringify({ url: websiteUrl })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          let icon = event.target;
          icon.innerText = (icon.innerText === "❤️") ? "♡" : "❤️";
          icon.classList.toggle("favorited");
        } else {
          Swal.fire("Error", data.message, "error");
        }
      })
      .catch(error => console.error("Error:", error));
    }


 // Function to add a website URL to the textarea.
 function addToTextarea(url) {
      const textarea = document.getElementById("website-url");
      const currentUrls = textarea.value.split("\n").map(u => u.trim());
      const urlsToAdd = [`www.${url}`, url ]; // Add both www and non-www versions
      urlsToAdd.forEach(u => {
        if (!currentUrls.includes(u)) {
          if (textarea.value.trim() === "") {
            textarea.value = u;
          } else {
            textarea.value += "\n" + u;
          }
        }
      });
    }
   
  </script>
  
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <header>
      <div class="menu-toggle" id="menu-toggle">
        <img src="{{ url_for('static', filename='images/menutoggle.png') }}" alt="Menu Toggle">
      </div>
    </header>
    <nav class="sidebar">
      <ul class="menu">
        <li><a href="{{ url_for('auth.success') }}">Home</a></li>
        <li><a href="{{ url_for('auth.categories') }}">Categories</a></li>
        <li><a href="{{ url_for('auth.favourites') }}" class="active">Favourites</a></li>
        <li><a href="#">Multi-Factor Authentication</a></li>
        <li><a href="#">Password Protection</a></li>
      </ul>
    </nav>
    
    <!-- Main Content -->
    <div class="main-content">
      <header class="topic">
        <h1>Your Favorite Categories</h1>
        <div>
          {% if session.get('user_id') %}
            <span class="welcome-text">Welcome, {{ session.get('user_name') }}!</span>
            <a href="{{ url_for('auth.signout') }}" class="signout">Sign Out</a>
          {% else %}
            <a href="{{ url_for('auth.signin') }}" class="signin">Sign In</a>
            <a href="{{ url_for('auth.signup') }}" class="signup">Sign Up</a>
          {% endif %}
        </div>
      </header>
      

         <!-- Block/Unblock Section -->
         <section id="block-unblock-section">
          <form id="block-website-form">
            <label for="website-url">Enter Website URL:</label>
            <textarea id="website-url" placeholder="e.g., www.example.com" rows="3"></textarea>
            <div class="button-group">
              <button type="button" id="block-btn">Block</button>
              <button type="button" id="unblock-btn">Unblock</button>
            </div>
          </form>
          <div id="blocked-websites">
            <h2>Blocked Websites:</h2>
            <ul id="blocked-list">
              <!-- Dynamically populated -->
            </ul>
          </div>
        </section>


      <!-- Favorite Default Categories Section -->
      <section id="favorite-default-categories">
        <h2>Favorite Default Categories</h2>
        {% if favorite_default_categories %}
          {% for category in favorite_default_categories %}
            <div class="category">
              <!-- Clicking on the h3 text toggles expansion -->
              <h3 onclick="toggleCategoryExpansion(this)">
                {{ category.title }}
                <!-- Category-level toggle icon; stops propagation so it doesn't collapse -->
                <span class="fav-icon" onclick="event.stopPropagation(); toggleCategoryFavorite(event, '{{ category.id }}', 'default')">
                  {{ '❤️' if category.id in user_favorites else '♡' }}
                </span>
              </h3>
              <ul>
                {% for website in category.websites %}
                  {% if website.url in favorite_websites.get(category.title, []) %}
                    <li>
                      {{ website.name }}
                      <span class="add-icon" onclick="addToTextarea('{{ website.url }}')">➕</span>
                      <span class="fav-icon" onclick="event.stopPropagation(); toggleWebsiteFavorite(event, '{{ category.id }}', 'default', '{{ website.url }}')">
                        {{ '❤️' if website.url in favorite_websites.get(category.title, []) else '♡' }}
                      </span>
                    </li>
                  {% endif %}
                {% endfor %}
              </ul>
            </div>
          {% endfor %}
        {% else %}
          <p>No favorite default categories added yet.</p>
        {% endif %}
      </section>

      <!-- Favorite Custom Categories Section -->
      <section id="favorite-custom-categories">
        <h2>Favorite Custom Categories</h2>
        {% if favorite_custom_categories %}
          {% for category in favorite_custom_categories %}
            <div class="category">
              <h3 onclick="toggleCategoryExpansion(this)">
                {{ category.title }}
                <span class="fav-icon" onclick="event.stopPropagation(); toggleCategoryFavorite(event, '{{ category.id }}', 'custom')">
                  {{ '❤️' if category.id in user_favorites else '♡' }}
                </span>
              </h3>
              <ul>
                {% for website in category.websites %}
                  {% if website.url in favorite_websites.get(category.title, []) %}
                    <li>
                      {{ website.name }}
                      <span class="add-icon" onclick="addToTextarea('{{ website.url }}')">➕</span>
                      <span class="fav-icon" onclick="event.stopPropagation(); toggleWebsiteFavorite(event, '{{ category.id }}', 'custom', '{{ website.url }}')">
                        {{ '❤️' if website.url in favorite_websites.get(category.title, []) else '♡' }}
                      </span>
                    </li>
                  {% endif %}
                {% endfor %}
              </ul>
            </div>
          {% endfor %}
        {% else %}
          <p>No favorite custom categories added yet.</p>
        {% endif %}
      </section>
      
   
      
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/app.js') }}?v=2"></script>
  <script src="{{ url_for('static', filename='js/script.js') }}?v=2"></script>
</body>
</html>
